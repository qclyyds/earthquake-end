# 滚动波形显示组件改进文档

## 改进概述
对 `scrolling_waveform.py` 中的实时模拟波形显示组件进行了重大改进，主要包括：

## 主要改进

### 1. 垂直滑动条Qt架构改进
- **原有问题**: 简单的QSlider实现，功能单一
- **改进方案**: 
  - 使用完整的Qt架构，包含上下箭头按钮
  - 添加通道信息显示标签
  - 更好的视觉反馈和用户交互

### 2. 动态画布大小适配
- **原有问题**: 固定大小的画布，不能适配窗口变化
- **改进方案**:
  - 实现 `adjust_canvas_size()` 方法，根据窗口大小和可见通道数动态调整
  - 智能计算每个通道的理想高度
  - 限制最大图形尺寸以避免内存过度使用

### 3. 窗口大小变化响应
- **新增功能**: 
  - 监听窗口resize事件
  - 延迟调整机制，避免频繁重绘
  - 自动重新计算布局和画布大小

### 4. 改进的用户界面
- **垂直滚动控件**:
  - 向上/向下按钮: ▲ ▼
  - 改进的滑动条带有双侧刻度
  - 实时通道信息显示 (如: "1-8 / 12")
  - 智能启用/禁用控件

### 5. 优化的绘图布局
- **智能布局**: 根据通道数量调整间距
  - 少量通道 (≤4): 使用较大间距
  - 多通道 (>4): 使用紧凑间距
- **改进的字体和网格**: 更小的字体，更细的网格线
- **更好的标题显示**: 包含时间和通道信息

### 6. X轴时间刻度改进

- **原有问题**: x轴显示相对时间（0到窗口长度），与实际时间不对应
- **改进方案**:
  - x轴显示实际的时间值，与波形分析时间点一致
  - 智能时间刻度间隔：根据窗口长度自动调整
  - 多种时间标签格式：秒数或分:秒格式
  - 相位检测标记位置与实际时间对应

#### 时间刻度规则

- **窗口 ≤ 30秒**: 每5秒一个主刻度，显示"5s"、"10s"格式
- **窗口 30-60秒**: 每10秒一个主刻度，显示"10s"、"20s"格式  
- **窗口 60-300秒**: 每30秒一个主刻度，显示"1:00"、"1:30"格式
- **窗口 > 300秒**: 每60秒一个主刻度，显示"2:00"、"3:00"格式

#### 改进前后对比

**改进前**:
```
x轴显示: 0s    5s    10s   15s   20s   25s   30s
含义:    相对时间，从窗口开始算起
问题:    无法知道实际的波形时间点
```

**改进后**:
```
窗口长度30秒时:
x轴显示: 45s   50s   55s   60s   65s   70s   75s
含义:    绝对时间，从波形开始算起的实际时间

窗口长度120秒时:
x轴显示: 2:00  2:30  3:00  3:30  4:00  4:30  5:00
含义:    分:秒格式，更易读的时间表示
```

#### 技术实现细节

**时间刻度计算**:
```python
# 根据窗口长度智能设置刻度间隔
if self.window_length <= 30:
    tick_interval = 5      # 每5秒一个刻度
elif self.window_length <= 60:
    tick_interval = 10     # 每10秒一个刻度
elif self.window_length <= 300:
    tick_interval = 30     # 每30秒一个刻度
else:
    tick_interval = 60     # 每60秒一个刻度
```

**时间标签格式**:
```python
# 短窗口显示秒数
tick_labels.append(f"{int(current_tick)}s")

# 长窗口显示时分秒
minutes = int(current_tick // 60)
seconds = int(current_tick % 60)
tick_labels.append(f"{minutes}:{seconds:02d}")
```

**实际时间点计算**:
```python
# 计算对应的实际时间点 - 相对于波形起始时间的绝对时间
times = np.linspace(window_start, window_end, len(data_slice))

# 更新x轴范围为当前时间窗口的实际时间
self.axes[trace_id].set_xlim(window_start, window_end)
```

## 新增方法

### `scroll_up()` 和 `scroll_down()`
```python
def scroll_up(self):
    """向上滚动一个位置"""

def scroll_down(self):
    """向下滚动一个位置"""
```

### `update_channel_info_label()`
```python
def update_channel_info_label(self):
    """更新通道信息标签 - 显示如 "1-8 / 12" 的格式"""
```

### `adjust_canvas_size()`
```python
def adjust_canvas_size(self):
    """动态调整画布大小以适配当前窗口和可见通道数"""
```

### `on_resize()` 和 `delayed_canvas_adjustment()`

```python
def on_resize(self, event):
    """处理窗口大小变化事件"""

def delayed_canvas_adjustment(self):
    """延迟的画布大小调整，避免频繁调整"""
```

### `update_time_axis()` 

```python
def update_time_axis(self, ax, window_start, window_end):
    """更新时间轴刻度，显示实际时间值"""
    # 根据窗口长度智能设置时间刻度间隔
    # 支持多种时间标签格式：秒数或分:秒格式
```

## 使用方法

1. **垂直滚动**:
   - 使用 ▲ ▼ 按钮逐个滚动
   - 拖动中间的滑动条快速跳转
   - 观察右侧的通道信息显示

2. **窗口大小适配**:
   - 拖拽窗口边缘改变大小
   - 画布会自动调整以适配新的窗口尺寸
   - 通道高度会智能分配

3. **多通道显示**:
   - 当通道数 > 8 时，自动启用垂直滚动
   - 当通道数 ≤ 8 时，显示所有通道
   - 实时显示当前可见的通道范围

4. **时间轴显示**:
   - x轴显示实际时间值，与波形分析时间点一致
   - 智能刻度间隔，根据窗口长度自动调整
   - 播放时x轴随时间移动，始终显示当前时间窗口
   - 相位检测标记精确对应实际时间位置

## 技术特点

- **内存效率**: 限制最大图形尺寸，避免过度内存使用
- **流畅交互**: 延迟调整机制，减少不必要的重绘
- **智能布局**: 根据内容动态调整显示参数
- **用户友好**: 清晰的视觉反馈和状态信息
- **时间精确**: x轴实时显示精确的时间刻度，与数据时间戳一致
- **自适应刻度**: 根据窗口长度自动选择最佳的时间刻度间隔和标签格式

## 兼容性

- 保持与原有API的完全兼容
- 所有原有功能继续正常工作
- 新功能为增量改进，不影响现有代码

## X轴时间刻度用户体验改进

1. **时间对应**: x轴时间与波形分析的时间点完全一致
2. **动态刻度**: 播放时x轴随时间移动，始终显示当前时间窗口
3. **智能格式**: 根据窗口长度自动选择最适合的时间标签格式
4. **精确定位**: 相位检测标记精确对应实际时间位置

## 应用场景

### 地震数据分析
- **精确时间定位**: 准确知道地震事件发生的具体时间点
- **相位对比**: P波和S波到达时间的精确测量
- **多台站同步**: 不同台站数据的时间同步分析

### 信号处理应用
- **特征识别**: 快速定位信号特征的准确时间位置
- **频谱分析**: 结合时间轴进行时频分析
- **异常检测**: 精确标记异常信号的时间范围

### 数据比较分析
- **时间段对比**: 不同时间段波形数据的直观比较
- **多通道同步**: 多个通道数据在相同时间轴上的对比
- **历史数据回放**: 按实际时间顺序回放历史数据

### 报告生成
- **科学报告**: 生成带有精确时间标记的专业波形图表
- **数据验证**: 确保报告中的时间信息准确无误
- **标准化输出**: 符合地震学标准的时间轴格式

## 测试验证

运行 `test_scrolling_waveform.py` 进行功能验证：

1. **时间刻度测试**: 观察不同窗口长度下的时间刻度变化
2. **播放同步测试**: 验证播放时x轴的实时更新
3. **窗口调整测试**: 测试窗口长度改变时刻度的智能调整
4. **相位标记测试**: 验证相位检测标记的时间准确性
